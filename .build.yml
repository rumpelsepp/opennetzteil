image: archlinux
packages:
  - go
  - git
  - python-pytest
  - python-requests

tasks:
  - setup: |
      git clone https://git.sr.ht/~rumpelsepp/pyopennetzteil

      cd opennetzteil
      make netzteild
      config="$HOME/.config/netzteil/config.toml"
      mkdir -p "$(dirname $config)"
      echo "[http]" > "$config"
      echo "bind = \":8000\"" >> "$config"
      echo "[[netzteile]]" >> "$config"
      echo "model = \"dummy\"" >> "$config"

  - test: |
      cd opennetzteil
      ./netzteild 2> "$HOME/requests.log" &
      cd ..
      cd pyopennetzteil
      make tests
      cat "$HOME/requests.log"
